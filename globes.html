<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üåç Battle</title>
  <link rel="stylesheet" href="globes.css" />
</head>
<body>
  <h1>üåç Battle</h1>

  <div class="bar">
    <div>
      <strong id="lvlLabel">Level</strong>
      <span id="metaLabel" class="muted"></span>
    </div>
    <div class="buttons">
      <button id="btnReset">Reset Level</button>
      <button id="btnClearProgress">Clear Progress</button>
    </div>
  </div>

  <div id="msg" class="msg" aria-live="polite"></div>

  <div id="grid" class="grid" aria-label="Puzzle grid"></div>

  <div id="winBox" class="win hidden">
    <div class="win-inner">
      <h2>Level complete</h2>
      <p>You beat it. The grid lost. Humanity remains a mixed bag. ‚úÖ</p>
      <button id="btnNext">Next Level</button>
    </div>
  </div>

  <script>
    const LEVEL_KEY = "globes_current_level";
    const UNLOCKED_KEY = "globes_unlocked_level";

    const $ = (id) => document.getElementById(id);

    const gridEl = $("grid");
    const msgEl = $("msg");
    const lvlLabel = $("lvlLabel");
    const metaLabel = $("metaLabel");
    const winBox = $("winBox");

    const btnReset = $("btnReset");
    const btnClearProgress = $("btnClearProgress");
    const btnNext = $("btnNext");

    let levelNumber = Number(localStorage.getItem(LEVEL_KEY) || "1");
    let unlocked = Number(localStorage.getItem(UNLOCKED_KEY) || "1");

    if (levelNumber < 1) levelNumber = 1;
    if (unlocked < 1) unlocked = 1;
    if (levelNumber > unlocked) levelNumber = unlocked;

    let levelData = null;     // JSON
    // state chars: '0' empty, '1' globe, '2' X
    let state = null;

    function setMsg(text) {
      msgEl.textContent = text;
    }

    function stateKeyForLevel(lvl) {
      return `globes_state_lvl${lvl}`;
    }

    function loadSavedStateOrEmpty() {
      const saved = localStorage.getItem(stateKeyForLevel(levelNumber));
      if (saved && saved.length === 100) return saved;
      return "0".repeat(100);
    }

    function saveState() {
      localStorage.setItem(stateKeyForLevel(levelNumber), state);
    }

    function clearState() {
      localStorage.removeItem(stateKeyForLevel(levelNumber));
      state = "0".repeat(100);
    }

    function idx(r, c) {
      return r * 10 + c;
    }

    function getCellState(r, c) {
      return state[idx(r, c)];
    }

    function setCellState(r, c, vChar) {
      const i = idx(r, c);
      state = state.substring(0, i) + vChar + state.substring(i + 1);
    }

    // Requested:
    // 1 press = X, 2 presses = üåç, 3 presses = empty
    // => empty -> X -> üåç -> empty
    function cycleCell(r, c) {
      const v = getCellState(r, c);
      const next = (v === "0") ? "2" : (v === "2") ? "1" : "0";
      setCellState(r, c, next);
      saveState();
      renderCell(r, c);
      checkWin();
    }

    function regionId(r, c) {
      return levelData.regions[r][c];
    }

    function renderGrid() {
      gridEl.innerHTML = "";
      gridEl.style.gridTemplateColumns = `repeat(10, var(--cell))`;

      for (let r = 0; r < 10; r++) {
        for (let c = 0; c < 10; c++) {
          const cell = document.createElement("button");
          cell.type = "button";
          cell.className = "cell";
          cell.dataset.r = String(r);
          cell.dataset.c = String(c);

          const rid = regionId(r, c);

          const topSame = (r > 0) && (regionId(r - 1, c) === rid);
          const leftSame = (c > 0) && (regionId(r, c - 1) === rid);
          const rightSame = (c < 9) && (regionId(r, c + 1) === rid);
          const botSame = (r < 9) && (regionId(r + 1, c) === rid);

          cell.style.borderTopWidth = topSame ? "1px" : "3px";
          cell.style.borderLeftWidth = leftSame ? "1px" : "3px";
          cell.style.borderRightWidth = rightSame ? "1px" : "3px";
          cell.style.borderBottomWidth = botSame ? "1px" : "3px";

          cell.addEventListener("click", () => cycleCell(r, c));

          gridEl.appendChild(cell);
          renderCell(r, c, cell);
        }
      }
    }

    function renderCell(r, c, el = null) {
      const cell = el || gridEl.querySelector(`.cell[data-r="${r}"][data-c="${c}"]`);
      const v = getCellState(r, c);
      cell.textContent = (v === "1") ? "üåç" : (v === "2") ? "X" : "";
    }

    function checkWin() {
      if (!levelData) return false;

      const k = levelData.k;

      const rowCounts = Array(10).fill(0);
      const colCounts = Array(10).fill(0);
      const regCounts = Array(10).fill(0);

      const dirs8 = [
        [-1,-1], [-1,0], [-1,1],
        [ 0,-1],         [ 0,1],
        [ 1,-1], [ 1,0], [ 1,1]
      ];

      let adjacencyOk = true;

      for (let r = 0; r < 10; r++) {
        for (let c = 0; c < 10; c++) {
          if (getCellState(r, c) !== "1") continue;

          rowCounts[r] += 1;
          colCounts[c] += 1;

          const rid = regionId(r, c);
          if (rid < 0 || rid > 9) return false;
          regCounts[rid] += 1;

          for (const [dr, dc] of dirs8) {
            const nr = r + dr, nc = c + dc;
            if (nr < 0 || nr > 9 || nc < 0 || nc > 9) continue;
            if (getCellState(nr, nc) === "1") adjacencyOk = false;
          }
        }
      }

      const rowsOk = rowCounts.every(v => v === k);
      const colsOk = colCounts.every(v => v === k);
      const regsOk = regCounts.every(v => v === k);

      if (rowsOk && colsOk && regsOk && adjacencyOk) {
        setMsg("Solved ‚úÖ");
        winBox.classList.remove("hidden");

        unlocked = Math.max(unlocked, levelNumber + 1);
        localStorage.setItem(UNLOCKED_KEY, String(unlocked));
        return true;
      }

      winBox.classList.add("hidden");

      const rowDone = rowCounts.filter(v => v === k).length;
      const colDone = colCounts.filter(v => v === k).length;
      const regDone = regCounts.filter(v => v === k).length;

      let extra = "";
      if (!adjacencyOk) extra = " Also: globes are touching (illegal).";

      setMsg(`Rows OK: ${rowDone}/10, Cols OK: ${colDone}/10, Regions OK: ${regDone}/10.${extra}`);
      return false;
    }

    async function loadLevel(lvl) {
      lvlLabel.textContent = `Level ${lvl}`;
      const url = `levels/lvl${lvl}.json`;

      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) {
        setMsg(`Could not load ${url} (${res.status}). Create levels/lvl${lvl}.json and commit it.`);
        gridEl.innerHTML = "";
        metaLabel.textContent = "";
        return null;
      }

      const data = await res.json();

      if (!data || data.n !== 10 || data.k !== 2 || !Array.isArray(data.regions) || data.regions.length !== 10) {
        setMsg(`Bad level JSON in ${url}. Expected n=10, k=2 and regions[10][10].`);
        return null;
      }

      return data;
    }

    btnReset.addEventListener("click", () => {
      clearState();
      renderGrid();
      checkWin();
    });

    btnClearProgress.addEventListener("click", () => {
      localStorage.removeItem(LEVEL_KEY);
      localStorage.removeItem(UNLOCKED_KEY);

      for (let i = 1; i <= 500; i++) {
        localStorage.removeItem(stateKeyForLevel(i));
      }

      levelNumber = 1;
      unlocked = 1;
      localStorage.setItem(LEVEL_KEY, "1");
      localStorage.setItem(UNLOCKED_KEY, "1");
      location.reload();
    });

    btnNext.addEventListener("click", async () => {
      const next = levelNumber + 1;

      localStorage.removeItem(stateKeyForLevel(levelNumber));

      const nextData = await loadLevel(next);
      if (!nextData) {
        setMsg(`No next level found (levels/lvl${next}.json). Generate it in panel.html and commit it.`);
        winBox.classList.add("hidden");
        return;
      }

      levelNumber = next;
      localStorage.setItem(LEVEL_KEY, String(levelNumber));

      levelData = nextData;
      metaLabel.textContent =
        `difficulty ${levelData.difficulty ?? "?"}` +
        (levelData.unique === true ? " ‚Ä¢ unique" : "");

      state = loadSavedStateOrEmpty();

      renderGrid();
      checkWin();
    });

    (async function init() {
      localStorage.setItem(LEVEL_KEY, String(levelNumber));
      localStorage.setItem(UNLOCKED_KEY, String(unlocked));

      levelData = await loadLevel(levelNumber);
      if (!levelData) return;

      metaLabel.textContent =
        `difficulty ${levelData.difficulty ?? "?"}` +
        (levelData.unique === true ? " ‚Ä¢ unique" : "");

      state = loadSavedStateOrEmpty();

      renderGrid();
      checkWin();
    })();
  </script>
</body>
</html>